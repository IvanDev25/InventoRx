<div class="medicine-container" style="padding: 100px;">


      <!-- Global Search Bar -->
      <div class="global-search-container">
        <div class="supplier-search-bar">
          <i class="search-icon"><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M20 20.0002L15.657 15.6572M15.657 15.6572C16.3998 14.9143 16.9891 14.0324 17.3912 13.0618C17.7932 12.0911 18.0002 11.0508 18.0002 10.0002C18.0002 8.9496 17.7932 7.90929 17.3912 6.93866C16.9891 5.96803 16.3998 5.08609 15.657 4.34321C14.9141 3.60032 14.0321 3.01103 13.0615 2.60898C12.0909 2.20693 11.0506 2 9.99996 2C8.94936 2 7.90905 2.20693 6.93842 2.60898C5.96779 3.01103 5.08585 3.60032 4.34296 4.34321C2.84263 5.84354 1.99976 7.87842 1.99976 10.0002C1.99976 12.122 2.84263 14.1569 4.34296 15.6572C5.84329 17.1575 7.87818 18.0004 9.99996 18.0004C12.1217 18.0004 14.1566 17.1575 15.657 15.6572Z" stroke="#989898" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg></i>
          <input type="text" placeholder="Search" class="search-input" (keyup)="applyFilter($event)">
        </div>
        
        <div class="supplier-controls">
          <button class="add-medicine-btn" (click)="openAddPatientModal()"> <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6 8H1C0.71667 8 0.479337 7.904 0.288004 7.712C0.0966702 7.52 0.000670115 7.28267 3.44827e-06 7C-0.000663218 6.71734 0.0953369 6.48 0.288004 6.288C0.48067 6.096 0.718003 6 1 6H6V1C6 0.71667 6.096 0.479337 6.288 0.288004C6.48 0.0966702 6.71734 0.000670115 7 3.44827e-06C7.28267 -0.000663218 7.52034 0.0953369 7.713 0.288004C7.90567 0.48067 8.00134 0.718003 8 1V6H13C13.2833 6 13.521 6.096 13.713 6.288C13.905 6.48 14.0007 6.71734 14 7C13.9993 7.28267 13.9033 7.52034 13.712 7.713C13.5207 7.90567 13.2833 8.00134 13 8H8V13C8 13.2833 7.904 13.521 7.712 13.713C7.52 13.905 7.28267 14.0007 7 14C6.71734 13.9993 6.48 13.9033 6.288 13.712C6.096 13.5207 6 13.2833 6 13V8Z" fill="white"/>
  </svg>
  
  Add Medicine</button>
        </div>
      </div>


  <div class="body-content">
    <table mat-table matSort class="custom-table" [dataSource]="paginatedData">

      <!-- Patient Name Column -->
      <ng-container matColumnDef="patientName">
        <th  class="th-header" mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
        <td class="td-body" mat-cell *matCellDef="let row" 
            [attr.rowspan]="row.isFirstMedicine ? row.rowspan : null"
            [style.display]="row.isFirstMedicine ? 'table-cell' : 'none'">
          {{ row.patientName }}
        </td>
      </ng-container>

      <!-- Medicine Name Column -->
      <ng-container matColumnDef="medicineName">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Medicine Name</th>
        <td class="td-body" mat-cell *matCellDef="let row">{{ row.medicineName }}</td>
      </ng-container>

      <!-- Supplier Name Column -->
      <ng-container matColumnDef="supplierName">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Consignor</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <span [class.regular-supplier]="row.supplierName === 'REGULAR'">{{ row.supplierName }}</span>
        </td>
      </ng-container>

      <!-- Issuance Column -->
      <ng-container matColumnDef="issuance">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Issuance</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <div class="issuance-input-container">
            <div class="issuance-input-wrapper">
              <input 
                type="number" 
                class="issuance-input" 
                placeholder="Quantity" 
                [(ngModel)]="row.issuance"
                min="1"
                (keyup.enter)="saveIssuance(row)"
                (keyup.escape)="cancelIssuance()"
                #issuanceInput>
              
              <div class="issuance-actions">
                <!-- Save button (checkmark icon) -->
                <button 
                  class="issuance-action-btn save-btn" 
                  (click)="saveIssuance(row)"
                  title="Save Issuance">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.5 4.5L6 12L2.5 8.5" stroke="#37A35C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Return Column -->
      <ng-container matColumnDef="return">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Return</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <!-- Checkbox initially displayed -->
          <div *ngIf="!row.showReturnInput" class="return-checkbox-container">
            <input 
              type="checkbox" 
              [checked]="false"
              (change)="toggleReturnInput(row, $any($event.target).checked)"
              class="return-checkbox">
            <span class="return-checkbox-label"></span>
          </div>

          <!-- Input interface when checkbox is checked -->
          <div *ngIf="row.showReturnInput" class="return-input-container">
            <div class="return-input-wrapper">
              <input 
                type="number" 
                class="return-input" 
                placeholder="Quantity" 
                [(ngModel)]="row.return"
                min="0"
                (keyup.enter)="saveReturn(row)"
                (keyup.escape)="cancelReturn(row)"
                #returnInput>
              
              <div class="return-actions">
                <!-- Cancel button (X icon) -->
                <button 
                  class="return-action-btn cancel-btn" 
                  (click)="cancelReturn(row)"
                  title="Cancel">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4L4 12M4 4L12 12" stroke="#FF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                
                <!-- Save button (checkmark icon) -->
                <button 
                  class="return-action-btn save-btn" 
                  (click)="saveReturn(row)"
                  title="Save Return">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.5 4.5L6 12L2.5 8.5" stroke="#37A35C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Stock Column -->
      <ng-container matColumnDef="stock">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Stock</th>
        <td class="td-body" mat-cell *matCellDef="let row">{{ row.stock }}</td>
      </ng-container>

      <!-- Quantity Column -->
      <ng-container matColumnDef="quantity">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Qty</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <span class="quantity-display" [class.negative-quantity]="row.quantity < 0">
            {{ row.quantity }}
          </span>
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Price</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <span class="price-display">
            ₱{{ row.price | number:'1.2-2' }}
          </span>
        </td>
      </ng-container>

      <!-- Price Total Column -->
      <ng-container matColumnDef="priceTotal">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Total</th>
        <td class="td-body" mat-cell *matCellDef="let row">
          <span class="price-total-display">
            ₱{{ row.priceTotal | number:'1.2-2' }}
          </span>
        </td>
      </ng-container>

      <!-- Patient Total Column -->
      <ng-container matColumnDef="patientTotal">
        <th class="th-header" mat-header-cell *matHeaderCellDef></th>
        <td class="td-body" mat-cell *matCellDef="let row" 
            [attr.rowspan]="row.isFirstMedicine ? row.rowspan : null"
            [style.display]="row.isFirstMedicine ? 'table-cell' : 'none'">
          <div class="patient-totals-container">
            <!-- Non-REGULAR Consigner Total (Top) -->
            <div *ngIf="row.nonRegularConsignerTotal > 0" class="other-container"
                 matTooltip="Consignor"
                 matTooltipPosition="right">
              <span class="other-amount">₱{{ row.nonRegularConsignerTotal | number:'1.2-2' }}</span>
            </div>
            
            <!-- REGULAR Consigner Total (Bottom) -->
            <div *ngIf="row.regularConsignerTotal > 0" class="regular-container"
                 matTooltip="REGULAR"
                 matTooltipPosition="right">
              <span class="regular-amount">₱{{ row.regularConsignerTotal | number:'1.2-2' }}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Action Column -->
      <ng-container matColumnDef="action">
        <th class="th-header" mat-header-cell *matHeaderCellDef>Action</th>
        <td class="td-body" mat-cell *matCellDef="let row" 
            [attr.rowspan]="row.isFirstMedicine ? row.rowspan : null"
            [style.display]="row.isFirstMedicine ? 'table-cell' : 'none'">

            <div class="action-buttons">
              <button mat-icon-button color="primary" (click)="editPatientMedicines(row)">
                <mat-icon><svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M9.70667 3.7041H2.33333C1.04417 3.7041 0 4.81127 0 6.1751V18.5278C0 19.8928 1.04417 20.9988 2.33333 20.9988H15.1667C16.4558 20.9988 17.5 19.8928 17.5 18.5278V9.4861L12.9337 14.3208C12.5349 14.7472 12.0156 15.0418 11.445 15.1654L8.31717 15.8281C6.2755 16.2598 4.4765 14.3546 4.88483 12.1939L5.51017 8.88177C5.62333 8.28444 5.901 7.73494 6.30817 7.30444L9.70667 3.7041Z" fill="#41454A"/>
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M19.6535 1.53655C19.5355 1.23792 19.3626 0.964069 19.1436 0.729216C18.9284 0.499533 18.6688 0.31579 18.3806 0.189049C18.0967 0.0643748 17.79 0 17.48 0C17.1699 0 16.8632 0.0643748 16.5793 0.189049C16.2911 0.31579 16.0316 0.499533 15.8163 0.729216L15.1793 1.40355L18.5066 4.92688L19.1436 4.25138C19.3649 4.01831 19.5381 3.74399 19.6535 3.44405C19.8938 2.83093 19.8938 2.14967 19.6535 1.53655ZM16.8581 6.67338L13.5296 3.14888L7.95648 9.05222C7.87425 9.13983 7.8188 9.24912 7.79665 9.36721L7.17131 12.6805C7.08965 13.1122 7.45015 13.4925 7.85731 13.4062L10.9863 12.7447C11.1002 12.7193 11.2038 12.6604 11.2838 12.5755L16.8581 6.67338Z" fill="#41454A"/>
                  </svg>
                  </mat-icon>
              </button>
              <!-- Show different button based on admission status -->
              <button mat-icon-button 
                      [color]="row.isAdmitted ? 'primary' : 'warn'" 
                      (click)="row.isAdmitted ? dischargePatient(row) : deletePatient(row)"
                      [title]="row.isAdmitted ? 'Discharge Patient' : 'Delete Patient'">
                <!-- Delete SVG for non-admitted patients -->
                <mat-icon *ngIf="!row.isAdmitted">
                  <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 18C2.45 18 1.97933 17.8043 1.588 17.413C1.19667 17.0217 1.00067 16.5507 1 16V3H0V1H5V0H11V1H16V3H15V16C15 16.55 14.8043 17.021 14.413 17.413C14.0217 17.805 13.5507 18.0007 13 18H3ZM5 14H7V5H5V14ZM9 14H11V5H9V14Z" fill="#41454A"/>
                  </svg>
                </mat-icon>
                <!-- Custom SVG for admitted patients -->
                <mat-icon *ngIf="row.isAdmitted">
                  <svg width="16" height="18" viewBox="0 0 70 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.91675 61.25V8.75H43.7501V61.25H29.1668V46.6667H17.5001V61.25H2.91675ZM14.5834 37.9167H20.4167V32.0833H14.5834V37.9167ZM14.5834 26.25H20.4167V20.4167H14.5834V26.25ZM26.2501 37.9167H32.0834V32.0833H26.2501V37.9167ZM26.2501 26.25H32.0834V20.4167H26.2501V26.25ZM56.8751 45.2083L52.7918 41.125L55.9272 37.9167H46.6668V32.0833H55.9272L52.7918 28.875L56.8751 24.7917L67.0834 35L56.8751 45.2083Z" fill="#41454A"/>
                  </svg>
                </mat-icon>
              </button>
            </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No Data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="11">
          <div class="no-data-message">
            <span class="no-data-icon">👥</span>
            <p class="no-data-text">No patient data found</p>
            <p class="no-data-subtext">Try adjusting your search or add new patients</p>
          </div>
        </td>
      </tr>
    </table>

    <app-custom-paginator
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    [pageSize]="pageSize"
    [totalItems]="totalItems"
    [maxVisiblePages]="5"
    (pageChange)="onPageChange($event)">
  </app-custom-paginator>
  </div>

</div>